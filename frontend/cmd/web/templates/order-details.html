<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      padding: 8px 12px;
      border: 1px solid #ddd;
    }

    thead {
      background-color: #f2f2f2;
    }

    tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    tr:hover {
      background-color: #eaeaea;
    }

  </style>

  <title>Order Details</title>
</head>
<body>

<table>
  <thead>
  <tr>
    <th>Buy Order UUID</th>
    <th>Total Cost</th>
    <th>Order Details</th>
  </tr>
  </thead>
  <tbody id="orderContainer">
  <!-- The actual data will be populated here using JavaScript -->
  </tbody>
</table>

<script>
  var orderContainer = document.getElementById('orderContainer');
  var buyOrders = {};

  function createOrderTableHTML(order) {
    return `
    <h2>Order: ${order.buyOrderUuid}</h2>
    <table data-uuid="${order.buyOrderUuid}">
        <thead>
            <tr>
                <th>Buy Order UUID</th>
                <th>Bread ID</th>
                <th>Quantity</th>
                <th>Price</th>
                <th>Status</th>
                <th>Created At</th>
                <th>Updated At</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
    <h3>Grand Total: ${order.totalCost}</h3>
    `;
  }


  function createOrderDetailHTML(detail) {
    // Check if essential fields are defined
    if(detail.breadId && detail.quantity && detail.price && detail.status && detail.created_at && detail.updated_at) {
      return `
        <tr data-uuid="${detail.buyOrderUuid}" data-bread-id="${detail.breadId}">
            <td>${detail.buyOrderUuid}</td>
            <td>${detail.breadId}</td>
            <td>${detail.quantity}</td>
            <td>${detail.price}</td>
            <td>${detail.status}</td>
            <td>${detail.created_at}</td>
            <td>${detail.updated_at}</td>
        </tr>`;
    } else {
      return ''; // If essential fields aren't defined, return an empty string, effectively skipping this detail
    }
  }

  var source = new EventSource("/order-stream");


  function appendOrderToDOM(order) {
    var orderElement = document.createElement('div');
    orderElement.innerHTML = createOrderTableHTML(order);
    orderContainer.appendChild(orderElement);
  }

  function appendDetailToDOM(detail) {
    var detailElement = document.createElement('tr');
    detailElement.setAttribute('data-uuid', detail.buyOrderUuid);
    detailElement.setAttribute('data-bread-id', detail.breadId);
    detailElement.innerHTML = createOrderDetailHTML(detail);

    var detailsTable = document.querySelector(`table[data-uuid="${detail.buyOrderUuid}"] tbody`);
    if (detailsTable) {
      detailsTable.appendChild(detailElement);
    }
  }

  source.onmessage = function(event) {
    var orderData = JSON.parse(event.data);

    // Ensure all the order tables are present
    orderData.buyOrders.forEach(order => {
      if (!buyOrders[order.buyOrderUuid]) {
        buyOrders[order.buyOrderUuid] = {
          header: order,
          details: []
        };
        // Add new order table for this order
        appendOrderToDOM(order);
      }
    });

    // Now populate details for each order
    orderData.buyOrderDetails.forEach(detail => {
      // Check if essential fields are defined before processing further
      if (detail.buyOrderUuid && detail.breadId && detail.quantity && detail.price && detail.status && detail.created_at && detail.updated_at) {
        if (!buyOrders[detail.buyOrderUuid].details.find(d => d.breadId === detail.breadId)) {
          buyOrders[detail.buyOrderUuid].details.push(detail);
          appendDetailToDOM(detail);
        } else {
          // Update the logic for existing rows here if needed
          var orderRow = document.querySelector(`tr[data-uuid="${detail.buyOrderUuid}"][data-bread-id="${detail.breadId}"]`);
          if (orderRow) {
            orderRow.cells[1].innerText = detail.breadId;
            orderRow.cells[2].innerText = detail.quantity;
            orderRow.cells[3].innerText = detail.price;
            orderRow.cells[4].innerText = detail.status;
            orderRow.cells[5].innerText = detail.created_at;
            orderRow.cells[6].innerText = detail.updated_at;
          }
        }
      }
    });
  };


</script>
</body>
</html>